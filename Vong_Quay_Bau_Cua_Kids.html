<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>V√≤ng Quay B·∫ßu Cua T√¥m C√° ‚Äî devbayosi</title>
<style>
:root{
  --font-main: "Segoe UI", Roboto, "Noto Sans", Arial, sans-serif;
  --card: rgba(255,255,255,.90);
  --ink:#1a1a1a;
  --shadow: 0 18px 46px rgba(0,0,0,.20);
  --gold:#ffd166;
}
*{box-sizing:border-box;font-family:var(--font-main);}
body{
  margin:0;min-height:100vh;color:var(--ink);
  overflow-x:hidden;
  background:
    radial-gradient(1200px 700px at 78% 10%, rgba(255,209,102,.45), transparent 60%),
    radial-gradient(1000px 680px at 18% 25%, rgba(255,77,109,.32), transparent 55%),
    radial-gradient(1000px 720px at 60% 92%, rgba(6,214,160,.28), transparent 62%),
    linear-gradient(180deg, #7a0010 0%, #b10016 32%, #ff4d6d 58%, #ffd166 82%, #06d6a0 100%);
}
/* √°nh v√†ng l·∫•p l√°nh */
body::before{
  content:"";
  position:fixed; inset:0;
  pointer-events:none;
  background-image:
    radial-gradient(circle at 20px 20px, rgba(255,255,255,.16) 2px, transparent 3px),
    radial-gradient(circle at 70px 60px, rgba(255,255,255,.10) 2px, transparent 3px),
    radial-gradient(circle at 120px 110px, rgba(255,255,255,.08) 1.6px, transparent 3px),
    radial-gradient(circle at 40px 120px, rgba(255,209,102,.18) 2px, transparent 4px);
  background-size: 170px 170px;
  opacity:.65;
  mix-blend-mode: screen;
}

/* ƒê√®n l·ªìng */
.lantern{
  position: fixed;
  top: -10px;
  width: 62px;
  height: 86px;
  background:
    radial-gradient(circle at 35% 30%, rgba(255,255,255,.55), transparent 45%),
    linear-gradient(180deg, #ff3b3b, #a40016);
  border-radius: 22px 22px 26px 26px;
  box-shadow: 0 18px 30px rgba(0,0,0,.22);
  border: 2px solid rgba(255,255,255,.22);
  transform-origin: top center;
  animation: sway 3.4s ease-in-out infinite;
  z-index: 2;
  pointer-events:none;
}
.lantern::before{
  content:"";
  position:absolute;
  top:-18px; left: 50%;
  width:2px; height: 18px;
  background: rgba(255,255,255,.45);
  transform: translateX(-50%);
}
.lantern::after{
  content:"";
  position:absolute;
  bottom:-16px; left:50%;
  width: 14px; height: 16px;
  background: linear-gradient(180deg, var(--gold), #d8a63f);
  border-radius: 0 0 10px 10px;
  transform: translateX(-50%);
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}
.lantern.l1{ left: 5vw; animation-duration: 3.2s; }
.lantern.l2{ right: 5vw; animation-duration: 3.8s; }
.lantern.l3{ left: 20vw; top: -24px; transform: scale(.85); animation-duration: 4.1s; opacity:.92; }
.lantern.l4{ right: 20vw; top: -24px; transform: scale(.85); animation-duration: 4.4s; opacity:.92; }
@keyframes sway{ 0%,100%{ transform: rotate(-5deg); } 50%{ transform: rotate(6deg); } }

/* Hoa mai r∆°i */
.petal{
  position: fixed;
  top: -10vh;
  width: 10px;
  height: 10px;
  background: radial-gradient(circle at 30% 30%, #fff6c2, #ffd166 55%, #d8a63f 100%);
  border-radius: 2px 50% 50% 50%;
  transform: rotate(25deg);
  opacity: .95;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.16));
  z-index: 1;
  animation: fall linear infinite;
  pointer-events:none;
}
@keyframes fall{
  0%{ transform: translateY(-12vh) translateX(0) rotate(0deg); }
  100%{ transform: translateY(112vh) translateX(var(--drift, 40px)) rotate(540deg); }
}

/* FX canvas confetti */
#fx{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 5;
}

/* ===== UI ===== */
header{text-align:center;color:#fff;padding:18px 14px 8px; position:relative; z-index:3}
h1{margin:0;font-weight:900;font-size:clamp(24px,3.2vw,40px);text-shadow:0 8px 18px rgba(0,0,0,.25)}
.subtitle{margin-top:8px;font-weight:700;opacity:.95;font-size:14px;line-height:1.35}

.wrap{display:grid;place-items:center;padding:12px 14px 30px; position:relative; z-index:3}
.stage{
  width:95%;max-width:1100px;
  display:grid;grid-template-columns:1.1fr .9fr;gap:16px;align-items:start
}
@media (max-width:980px){ .stage{grid-template-columns:1fr;} }

.card{background:var(--card);border-radius:22px;padding:16px;box-shadow:var(--shadow);backdrop-filter: blur(6px)}
.wheelCard{display:grid;place-items:center;gap:12px}

/* Pointer */
.pointer{
  width:0;height:0;
  border-left:16px solid transparent;
  border-right:16px solid transparent;
  border-bottom:32px solid #fff;
  filter: drop-shadow(0 8px 10px rgba(0,0,0,.22));
  margin-bottom:-10px;
}
#wheel{width:520px;max-width:90vw;border-radius:50%;box-shadow:0 12px 28px rgba(0,0,0,.22)}

.controls{
  display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center
}
button{
  font-weight:900;border-radius:999px;padding:12px 18px;border:none;cursor:pointer;
  transition:transform .08s ease,opacity .2s ease;
}
button:active{transform:translateY(1px) scale(.99)}
button:disabled{opacity:.6;cursor:not-allowed}
.btnSpin{background:linear-gradient(180deg,#fff,var(--gold));color:#2b1d00}
.btnFast{background:linear-gradient(180deg,#ff7a8f,#ff4d6d);color:#fff}
.btnReset,.btnClear{
  background:#fff;border:1px solid rgba(0,0,0,.1);color:#2b1d00;font-weight:900
}
.toggle{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.08);
  font-weight:900;color:#2b1d00;user-select:none
}
.toggle input{transform:scale(1.1)}

/* Countdown widget (replaces timed spin button) */
.timerWidget{
  min-width: 220px;
  padding: 10px 14px;
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,209,102,.88));
  color:#2b1d00;
  border: 1px solid rgba(0,0,0,.08);
  box-shadow: 0 10px 22px rgba(0,0,0,.12);
  text-align:center;
  user-select:none;
  cursor:pointer;
  transition: transform .08s ease, filter .2s ease, opacity .2s ease;
}
.timerWidget:active{ transform: translateY(1px) scale(.99); }
.timerWidget[aria-disabled="true"]{ opacity:.6; cursor:not-allowed; }
.twTop{ font-weight:900; font-size:13px; letter-spacing:.3px; }
.twTime{ font-weight:900; font-size:30px; margin-top:2px; line-height:1; }
.twS{ font-size:18px; margin-left:2px; }
.twHint{ font-weight:700; font-size:11px; opacity:.85; margin-top:4px; }


.statusRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%}
.pill{
  text-align:center;font-weight:900;background:#fff;border-radius:18px;padding:10px;border:1px solid rgba(0,0,0,.06)
}
.pill .label{font-size:12px;opacity:.75;text-transform:uppercase;font-weight:900}
.pill .big{font-size:24px;font-weight:900;margin-top:2px}
.bigResult{font-size:28px}

h2{margin:0 0 10px 0;font-weight:900;color:#2b1d00}
table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:14px}
th,td{padding:10px;font-size:14px}
th{background:var(--gold);font-weight:900}
tr:nth-child(even) td{background:rgba(6,214,160,.08)}
.badge{font-weight:900}
footer{text-align:center;color:#fff;font-size:13px;font-weight:700;padding-bottom:16px; position:relative; z-index:3}

/* ===== POPUP RESULT ===== */
#overlay{
  position:fixed;inset:0;
  background: rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
#overlay.show{ display:flex; }
.popup{
  width:min(420px, 90vw);
  background: rgba(255,255,255,.96);
  border-radius: 22px;
  box-shadow: 0 24px 60px rgba(0,0,0,.28);
  padding: 18px 16px 14px;
  text-align:center;
  border: 2px solid rgba(255,209,102,.55);
  transform: scale(.88);
  opacity: 0;
  animation: popIn .32s ease forwards;
}
@keyframes popIn{ to{ transform: scale(1); opacity: 1; } }
.popupTitle{ font-weight:900; color:#2b1d00; font-size:18px; margin-bottom: 10px; }
.popupIcon{ font-size: 92px; line-height: 1; margin: 6px 0 6px; }
.popupName{ font-weight:900; font-size: 30px; color:#1a1a1a; margin-bottom: 12px; }
.popupBtns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.popupBtns button{ padding: 10px 16px; font-size: 15px; }
.btnOk{ background: linear-gradient(180deg,#fff,var(--gold)); color:#2b1d00; }
.btnAgain{ background:#fff; border: 1px solid rgba(0,0,0,.12); color:#2b1d00; }
.popupHint{ margin-top:10px; font-size:12px; font-weight:700; opacity:.8; }



/* === Layout balance for kids (buttons smaller, timer below) === */
.controls{
  width:100%;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.actionBar{
  width:100%;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
.timerRow{
  display:flex;
  justify-content:center;
}
.timerWidget{
  width:min(520px, 100%);
  height: 100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.btnFast, .btnReset{
  min-height: 48px;
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 999px;
}
@media (max-width:420px){
  .btnFast, .btnReset{ width:100%; }
  .timerWidget{ width:100%; }
}
.soundBar{
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}


/* ===== Extra festive decorations ===== */
.ribbon{
  display:inline-flex; align-items:center; justify-content:center; gap:10px;
  margin: 0 auto 10px; padding: 10px 14px; border-radius: 999px;
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,209,102,.85));
  color:#2b1d00; font-weight:900;
  box-shadow: 0 12px 24px rgba(0,0,0,.16);
  border: 1px solid rgba(0,0,0,.08);
  max-width: min(820px, 92vw);
}
.festiveRow{
  margin-top: 10px;
  font-size: 18px;
  letter-spacing: 6px;
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.18));
}
.festiveLayer{ position:fixed; inset:0; pointer-events:none; z-index:2; }
.sticker{
  position:absolute; width: 74px; height: 74px; border-radius: 18px;
  box-shadow: 0 18px 30px rgba(0,0,0,.16);
  transform: rotate(var(--rot, -8deg));
  opacity:.95;
}
.sticker::after{
  content: attr(title);
  position:absolute; left:50%; bottom:-22px; transform: translateX(-50%);
  font-size: 11px; font-weight: 900; color: rgba(255,255,255,.92);
  text-shadow: 0 6px 12px rgba(0,0,0,.35); white-space: nowrap; opacity:.85;
}
.sticker.bao{ left: 18px; top: 120px; --rot:-10deg;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 45%),
              linear-gradient(180deg, #ff4d6d, #a40016);
  border: 2px solid rgba(255,209,102,.65);
}
.sticker.bao::before{ content:"üßß"; position:absolute; inset:0; display:grid; place-items:center; font-size: 42px; }
.sticker.firecracker{ right: 18px; top: 120px; --rot:10deg;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 45%),
              linear-gradient(180deg, #ffca3a, #d85d00);
  border: 2px solid rgba(255,255,255,.4);
}
.sticker.firecracker::before{ content:"üéÜ"; position:absolute; inset:0; display:grid; place-items:center; font-size: 42px; }
.sticker.mai{ left: 22px; bottom: 72px; --rot:8deg;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 45%),
              linear-gradient(180deg, #06d6a0, #1982c4);
  border: 2px solid rgba(255,255,255,.38);
}
.sticker.mai::before{ content:"üå∏"; position:absolute; inset:0; display:grid; place-items:center; font-size: 42px; }
.sticker.peach{ right: 22px; bottom: 72px; --rot:-8deg;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 45%),
              linear-gradient(180deg, #ff9f1c, #ff4d6d);
  border: 2px solid rgba(255,255,255,.34);
}
.sticker.peach::before{ content:"üå∫"; position:absolute; inset:0; display:grid; place-items:center; font-size: 42px; }

.sparkle{
  position:absolute; width: 10px; height: 10px; border-radius: 50%;
  background: radial-gradient(circle at 35% 35%, #fff, rgba(255,209,102,.9) 45%, transparent 70%);
  opacity:.9; filter: drop-shadow(0 10px 16px rgba(0,0,0,.18));
  animation: sparkle 1.6s ease-in-out infinite;
}
.sparkle.s1{ left: 18%; top: 16%; animation-delay:.0s; transform: scale(1.1); }
.sparkle.s2{ right: 20%; top: 18%; animation-delay:.4s; transform: scale(.9); }
.sparkle.s3{ left: 22%; bottom: 22%; animation-delay:.7s; transform: scale(.95); }
.sparkle.s4{ right: 18%; bottom: 24%; animation-delay:1.0s; transform: scale(1.05); }
@keyframes sparkle{ 0%,100%{ transform: scale(.75); opacity:.55; } 50%{ transform: scale(1.25); opacity:1; } }

/* Buttons/timer balance */
.controls{ width:100%; display:flex; flex-direction:column; gap:10px; }
.actionBar{ width:100%; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
.timerRow{ display:flex; justify-content:center; }
.timerWidget{ width:min(520px, 100%); }
.btnFast, .btnReset{ min-height: 48px; padding: 10px 14px; font-size: 15px; }

/* Ultra polish */
#wheel{ animation: wheelGlow 3.6s ease-in-out infinite; }
@keyframes wheelGlow{
  0%,100%{ box-shadow:0 12px 28px rgba(0,0,0,.22), 0 0 0 rgba(255,209,102,0); }
  50%{ box-shadow:0 14px 34px rgba(0,0,0,.26), 0 0 26px rgba(255,209,102,.45); }
}
button:hover{ filter: brightness(1.05) saturate(1.05); }
button:hover::after{ content:"‚ú®"; margin-left:6px; }

/* Floating coins */
.coin{
  position:fixed; width:18px; height:18px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fff, #ffd166 60%, #d8a63f);
  box-shadow:0 10px 16px rgba(0,0,0,.18);
  animation: coinFloat 6s linear infinite;
  opacity:.85; z-index:1; pointer-events:none;
}
@keyframes coinFloat{
  0%{ transform: translateY(110vh) translateX(0) rotate(0deg); }
  100%{ transform: translateY(-20vh) translateX(var(--dx,40px)) rotate(720deg); }
}

@media (max-width:680px){
  .sticker{ width:60px; height:60px; }
  .sticker::before{ font-size:36px; }
  .sticker::after{ display:none; }
  .sticker.bao{ top: 94px; }
  .sticker.firecracker{ top: 94px; }
}


/* Disable hover sparkle on "XO√Å L·ªäCH S·ª¨" button */
#btnClear:hover{ filter:none !important; }
#btnClear:hover::after{ content:"" !important; margin-left:0 !important; }


/* Popup flash pulse when showing result */
#overlay.show .popup{
  box-shadow: 0 24px 60px rgba(0,0,0,.28), 0 0 0 rgba(255,209,102,0);
}
#overlay.show.firework .popup{
  animation: popIn .32s ease forwards, popupFlash .55s ease-out 1;
}
@keyframes popupFlash{
  0%{ box-shadow: 0 24px 60px rgba(0,0,0,.28), 0 0 0 rgba(255,209,102,0); }
  35%{ box-shadow: 0 24px 60px rgba(0,0,0,.28), 0 0 32px rgba(255,209,102,.65); }
  100%{ box-shadow: 0 24px 60px rgba(0,0,0,.28), 0 0 0 rgba(255,209,102,0); }
}

</style>
</head>
<body>
  <!-- Extra festive layer -->
  <div class="festiveLayer" aria-hidden="true">
    <div class="sticker bao" title="Bao l√¨ x√¨"></div>
    <div class="sticker firecracker" title="Ph√°o t·∫øt"></div>
    <div class="sticker mai" title="Hoa mai"></div>
    <div class="sticker peach" title="Hoa ƒë√†o"></div>
    <div class="sparkle s1"></div><div class="sparkle s2"></div><div class="sparkle s3"></div><div class="sparkle s4"></div>
  </div>
  <div id='coinLayer' aria-hidden='true'></div>

  <!-- T·∫øt decorations -->
  <div class="lantern l1" aria-hidden="true"></div>
  <div class="lantern l2" aria-hidden="true"></div>
  <div class="lantern l3" aria-hidden="true"></div>
  <div class="lantern l4" aria-hidden="true"></div>
  <canvas id="fx"></canvas>

<header>
  <div class="ribbon">üéä Ch√∫c M·ª´ng NƒÉm M·ªõi ‚Ä¢ Vui T·∫øt C√πng B√© üéä</div>
  <h1>üé° V√≤ng Quay B·∫ßu Cua T√¥m C√° üßß</h1>
</header>

<div class="wrap">
  <div class="stage">

    <div class="card wheelCard">
      <div class="pointer" title="M≈©i t√™n ch·ªâ k·∫øt qu·∫£"></div>
      <canvas id="wheel" width="520" height="520"></canvas>

      


<div class="controls">
  <div class="actionBar" aria-label="Khu ƒëi·ªÅu khi·ªÉn ch√≠nh">
    <button class="btnFast" id="btnFast" title="Quay ngay kh√¥ng c·∫ßn ch·ªù">‚ö° QUAY NGAY</button>
    <button class="btnReset" id="btnReset" title="ƒê∆∞a v√≤ng quay v·ªÅ ban ƒë·∫ßu">L√ÄM L·∫†I</button>
  </div>

  <div class="timerRow" aria-label="B·ªô ƒë·∫øm gi·ªù">
    <div class="timerWidget" id="timerWidget" role="button" tabindex="0" aria-label="B·ªô ƒë·∫øm 10 gi√¢y">
      <div class="twTop">‚è≥ B·ªò ƒê·∫æM 10 GI√ÇY</div>
      <div class="twTime"><span id="twSeconds">10</span><span class="twS">s</span></div>
      <div class="twHint">B·∫•m ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫øm</div>
    </div>
  </div>

  <div class="soundBar" aria-label="√Çm thanh">
    <label class="toggle" title="B·∫≠t/T·∫Øt √¢m thanh hi·ªáu ·ª©ng">
      <input type="checkbox" id="soundToggle" checked> √ÇM THANH
    </label>
    <label class="toggle" title="B·∫≠t/T·∫Øt nh·∫°c n·ªÅn nh·∫π nh√†ng">
      <input type="checkbox" id="musicToggle"> NH·∫†C N·ªÄN
    </label>
  </div>
</div>

<div class="statusRow">



        <div class="pill"><div class="label">ƒê·∫øm ng∆∞·ª£c</div><div class="big" id="countdown">‚Äî</div></div>
        <div class="pill"><div class="label">K·∫øt qu·∫£</div><div class="big bigResult" id="result">‚ú®</div></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h2>üìã B·∫£ng k·∫øt qu·∫£ (10 l∆∞·ª£t)</h2>
        <button class="btnClear" id="btnClear">XO√Å L·ªäCH S·ª¨</button>
      </div>
      <table aria-label="B·∫£ng k·∫øt qu·∫£">
        <thead><tr><th style="width:56px;text-align:center">#</th><th>K·∫øt qu·∫£</th><th style="width:110px;text-align:center">Gi·ªù</th></tr></thead>
        <tbody id="history"></tbody>
      </table>
    </div>

  </div>
</div>

<footer>Mini game B·∫ßu Cua T√¥m C√° Copyright ¬©devbayosi</footer>

<!-- Popup overlay -->
<div id="overlay" role="dialog" aria-modal="true" aria-label="K·∫øt qu·∫£ v√≤ng quay">
  <div class="popup">
    <div class="popupTitle" id="popupTitle">üéâ K·∫æT QU·∫¢ C·ª¶A B·∫†N üéâ</div>
    <div class="popupIcon" id="popupIcon">‚ú®</div>
    <div class="popupName" id="popupName">‚Äî</div>
    <div class="popupBtns">
      <button class="btnOk" id="btnOk">ƒê√≥ng</button>
      <button class="btnAgain" id="btnAgain">Quay ti·∫øp</button>
    </div>
    <div class="popupHint" id="popupHint">L·ª±a ch·ªçn n√∫t t∆∞∆°ng ·ª©ng</div>
  </div>
</div>

<script>
/* ===== Petals create ===== */
(function makePetals(){
  const COUNT = 24;
  for(let i=0;i<COUNT;i++){
    const p = document.createElement("div");
    p.className = "petal";
    const left = Math.random()*100;
    const dur = 6 + Math.random()*6;
    const delay = Math.random()*-dur;
    const drift = (Math.random()*120 - 60).toFixed(0) + "px";
    const size = 7 + Math.random()*9;
    p.style.left = left + "vw";
    p.style.animationDuration = dur + "s";
    p.style.animationDelay = delay + "s";
    p.style.setProperty("--drift", drift);
    p.style.width = size + "px";
    p.style.height = size + "px";
    p.style.opacity = (0.55 + Math.random()*0.45).toFixed(2);
    document.body.appendChild(p);
  }
})();

/* ===== Data ===== */
const items=[
  {name:"B·∫ßu",icon:"üçê"},
  {name:"Cua",icon:"ü¶Ä"},
  {name:"T√¥m",icon:"ü¶ê"},
  {name:"C√°", icon:"üêü"},
  {name:"Nai",icon:"ü¶å"},
  {name:"G√†", icon:"üêì"}
];
const colors=["#ff595e","#ffca3a","#8ac926","#1982c4","#6a4c93","#ff9f1c"];

/* ===== Canvas wheel ===== */
const wheel=document.getElementById("wheel");
const ctx=wheel.getContext("2d");
let angle=0;
let spinning=false;

/* ===== History (max 10) ===== */
let history=[];
const MAX_HISTORY=10;

function addHistory(item){
  const time=new Date().toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"});
  history.unshift({item,time});
  if(history.length>MAX_HISTORY) history.pop();
  renderHistory();
}
function renderHistory(){
  const body=document.getElementById("history");
  body.innerHTML="";
  history.forEach((h,i)=>{
    body.innerHTML += `<tr>
      <td style="text-align:center;font-weight:900">${history.length-i}</td>
      <td class="badge" style="font-weight:900">${h.item.icon} ${h.item.name}</td>
      <td style="text-align:center;font-weight:900">${h.time}</td>
    </tr>`;
  });
}

const btnClear = document.getElementById("btnClear");
btnClear.onclick=()=>{ if(spinning||timer) return; history=[]; renderHistory(); };

/* ===== Draw wheel (icons only & big) ===== */
function drawWheel(a){
  const r=wheel.width/2;
  ctx.clearRect(0,0,wheel.width,wheel.height);
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(a);
  const slice=Math.PI*2/items.length;

  // outer ring
  ctx.beginPath();
  ctx.arc(0,0,r-4,0,Math.PI*2);
  ctx.strokeStyle="rgba(255,255,255,.45)";
  ctx.lineWidth=12;
  ctx.stroke();

  for(let i=0;i<items.length;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.fillStyle=colors[i%colors.length];
    ctx.arc(0,0,r-10,i*slice,(i+1)*slice);
    ctx.fill();

    ctx.beginPath();
    ctx.strokeStyle="rgba(255,255,255,.78)";
    ctx.lineWidth=4;
    ctx.arc(0,0,r-12,i*slice,(i+1)*slice);
    ctx.stroke();

    // icon only - big & near outer area so pointer points clearly
    ctx.save();
    ctx.rotate(i*slice + slice/2);
    ctx.textAlign="center";
    ctx.font="900 80px Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji, sans-serif";
    ctx.fillStyle="rgba(0,0,0,.92)";
    ctx.fillText(items[i].icon, r-118, 28);
    ctx.restore();
  }

  // center cap
  ctx.beginPath(); ctx.fillStyle="rgba(255,255,255,.92)"; ctx.arc(0,0,64,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.fillStyle="#ffd166"; ctx.arc(0,0,42,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="rgba(43,29,0,.92)";
  ctx.font="900 16px 'Segoe UI', Roboto, 'Noto Sans', Arial, sans-serif";
  ctx.textAlign="center";
  ctx.fillText("B·∫¶U CUA", 0, 6);

  ctx.restore();
}

/* ===== Pointer index ===== */
function normalizeDeg(d){ d=d%360; if(d<0) d+=360; return d; }
function currentIndexFromAngle(angleRad){
  const deg = normalizeDeg(360 - (angleRad * 180/Math.PI));
  const slice = 360/items.length;
  return Math.floor(deg / slice) % items.length;
}

/* ===== Sounds (WebAudio) ‚Äî PRO ===== */
const soundToggle = document.getElementById("soundToggle");
const musicToggle = document.getElementById("musicToggle");

let audioCtx = null;
let master = null, comp = null;
let sfxGain = null, musicGain = null;
let echo = null, echoFb = null, echoLP = null;

let musicNode = null;
let musicTimer = null;

function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();

    comp = audioCtx.createDynamicsCompressor();
    comp.threshold.value = -22;
    comp.knee.value = 18;
    comp.ratio.value = 3.2;
    comp.attack.value = 0.004;
    comp.release.value = 0.18;

    master = audioCtx.createGain();
    master.gain.value = 0.85;

    // light echo (parallel send)
    echo = audioCtx.createDelay(0.25);
    echo.delayTime.value = 0.14;
    echoFb = audioCtx.createGain();
    echoFb.gain.value = 0.22;
    echoLP = audioCtx.createBiquadFilter();
    echoLP.type = "lowpass";
    echoLP.frequency.value = 1800;
    echo.connect(echoLP).connect(echoFb).connect(echo);
    echo.connect(comp);

    sfxGain = audioCtx.createGain();
    sfxGain.gain.value = 0.95;
    sfxGain.connect(comp);

    musicGain = audioCtx.createGain();
    musicGain.gain.value = 0.07;
    musicGain.connect(comp);

    comp.connect(master).connect(audioCtx.destination);
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
}
function canSfx(){ return soundToggle.checked; }

function sfxOut(withEcho=false){
  ensureAudio();
  if(withEcho){
    const g = audioCtx.createGain();
    g.gain.value = 1;
    g.connect(sfxGain);
    g.connect(echo);
    return g;
  }
  return sfxGain;
}

function makeNoise(duration=0.08){
  const bufferSize = Math.max(1, Math.floor(audioCtx.sampleRate * duration));
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<bufferSize;i++){
    const t = i / bufferSize;
    data[i] = (Math.random()*2-1) * Math.pow(1 - t, 2.3);
  }
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  return src;
}

function playTick(){
  if(!canSfx()) return;
  ensureAudio();
  const t = audioCtx.currentTime;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = "triangle";
  o.frequency.setValueAtTime(1200, t);
  o.frequency.exponentialRampToValueAtTime(720, t+0.03);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.22, t+0.008);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.06);
  o.connect(g).connect(sfxOut(true));
  o.start(t); o.stop(t+0.07);

  const n = makeNoise(0.04);
  const nf = audioCtx.createBiquadFilter();
  nf.type = "highpass";
  nf.frequency.value = 1400;
  const ng = audioCtx.createGain();
  ng.gain.setValueAtTime(0.0001, t);
  ng.gain.exponentialRampToValueAtTime(0.14, t+0.008);
  ng.gain.exponentialRampToValueAtTime(0.0001, t+0.05);
  n.connect(nf).connect(ng).connect(sfxOut(true));
  n.start(t); n.stop(t+0.05);
}

function playStartWhoosh(){
  if(!canSfx()) return;
  ensureAudio();
  const t = audioCtx.currentTime;

  const n = makeNoise(0.22);
  const f = audioCtx.createBiquadFilter();
  f.type = "bandpass";
  f.frequency.setValueAtTime(420, t);
  f.frequency.exponentialRampToValueAtTime(2400, t+0.18);
  f.Q.value = 0.9;

  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.20, t+0.03);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.24);

  n.connect(f).connect(g).connect(sfxOut(true));
  n.start(t); n.stop(t+0.24);
}

function playDrumRoll(){
  if(!canSfx()) return;
  ensureAudio();
  const t0 = audioCtx.currentTime;
  for(let i=0;i<6;i++){
    const t = t0 + i*0.08;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='triangle';
    o.frequency.setValueAtTime(220+i*40, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.12, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.07);
    o.connect(g).connect(sfxOut(false));
    o.start(t); o.stop(t+0.08);
  }
}

function playCountdownBeep(sec){
  if(!canSfx()) return;
  ensureAudio();
  const t = audioCtx.currentTime;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.value = 2200;

  o.type = "square";
  const base = (sec<=1)? 1280 : 980;
  o.frequency.setValueAtTime(base, t);
  o.frequency.exponentialRampToValueAtTime(base*0.92, t+0.06);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.16, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.10);

  o.connect(lp).connect(g).connect(sfxOut(false));
  o.start(t); o.stop(t+0.12);
}

function playWin(){
  if(!canSfx()) return;
  ensureAudio();
  const now = audioCtx.currentTime;

  const chord = [523.25, 659.25, 783.99, 1046.5];
  chord.forEach((f0, i)=>{
    const t = now + i*0.05;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass"; lp.frequency.value = 2600;

    o.type = "sine";
    o.frequency.setValueAtTime(f0, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.18, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.22);

    o.connect(lp).connect(g).connect(sfxOut(true));
    o.start(t); o.stop(t+0.26);
  });

  const n = makeNoise(0.18);
  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass"; hp.frequency.value = 1800;
  const ng = audioCtx.createGain();
  ng.gain.setValueAtTime(0.0001, now+0.02);
  ng.gain.exponentialRampToValueAtTime(0.12, now+0.04);
  ng.gain.exponentialRampToValueAtTime(0.0001, now+0.22);
  n.connect(hp).connect(ng).connect(sfxOut(true));
  n.start(now+0.02); n.stop(now+0.22);
}

function playTimeUp(){
  if(!canSfx()) return;
  ensureAudio();
  const base = audioCtx.currentTime;
  [0, 0.20, 0.40].forEach((dt, idx)=>{
    const t = base + dt;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const bp = audioCtx.createBiquadFilter();
    bp.type = "bandpass"; bp.frequency.value = 1200; bp.Q.value = 6;

    o.type = "square";
    o.frequency.setValueAtTime(idx===2 ? 900 : 1200, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.18, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.14);

    o.connect(bp).connect(g).connect(sfxOut(true));
    o.start(t); o.stop(t+0.16);
  });
}

/* ===== Background music (gentle festive) ===== */
function stopMusic(){
  if(musicTimer){ clearInterval(musicTimer); musicTimer = null; }
  if(musicNode){ try{ musicNode.stop(); }catch(e){} musicNode = null; }
}
function startMusic(){
  ensureAudio();
  stopMusic();

  musicNode = audioCtx.createOscillator();
  const mg = audioCtx.createGain();
  musicNode.type = "sine";
  musicNode.frequency.value = 196; // G3
  mg.gain.value = 0.20;
  musicNode.connect(mg).connect(musicGain);
  musicNode.start();

  const notes = [392, 440, 523.25, 587.33, 659.25]; // G A C D E
  musicTimer = setInterval(() => {
    if(!musicToggle.checked) return;
    const t = audioCtx.currentTime;

    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    const lp = audioCtx.createBiquadFilter();
    lp.type = "lowpass"; lp.frequency.value = 2400;

    o.type = "sine";
    o.frequency.setValueAtTime(notes[Math.floor(Math.random()*notes.length)], t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.10, t+0.012);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.22);

    o.connect(lp).connect(g).connect(musicGain);
    o.start(t); o.stop(t+0.26);

    if(Math.random() < 0.16){
      const n = makeNoise(0.07);
      const hp = audioCtx.createBiquadFilter();
      hp.type="highpass"; hp.frequency.value = 2000;
      const ng = audioCtx.createGain();
      ng.gain.setValueAtTime(0.0001, t);
      ng.gain.exponentialRampToValueAtTime(0.05, t+0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, t+0.08);
      n.connect(hp).connect(ng).connect(musicGain);
      n.start(t); n.stop(t+0.08);
    }
  }, 430);
}

musicToggle.addEventListener("change", () => {
  if(!musicToggle.checked) stopMusic();
  else { try{ startMusic(); }catch(e){} }
});

/* ===== Confetti FX ===== */
const fx = document.getElementById("fx");
const fxCtx = fx.getContext("2d");
function resizeFx(){
  fx.width = innerWidth * devicePixelRatio;
  fx.height = innerHeight * devicePixelRatio;
  fx.style.width = innerWidth + "px";
  fx.style.height = innerHeight + "px";
  fxCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
addEventListener("resize", resizeFx);
resizeFx();

let confetti = [];
let sparks = [];
let running = false;
function confettiBurst(){
  const x = innerWidth/2;
  const y = 160;
  const N = 180;
  const palette = ["#ff595e","#ffca3a","#8ac926","#1982c4","#6a4c93","#ffffff", "#ffd166"];
  for(let i=0;i<N;i++){
    confetti.push({
      x, y,
      vx: (Math.random()*10-5),
      vy: (Math.random()*-11-4),
      g: 0.23 + Math.random()*0.12,
      w: 3 + Math.random()*4,
      h: 2 + Math.random()*4,
      a: 1,
      rot: Math.random()*Math.PI*2,
      vr: (Math.random()*0.22-0.11),
      c: palette[Math.floor(Math.random()*palette.length)]
    });
  }
  if(!running) runFx();
}

function fireworksBurst(cx, cy){
  const N = 120;
  const palette = ["#ff595e","#ffca3a","#8ac926","#1982c4","#6a4c93","#ffffff", "#ffd166", "#ff4d6d"];
  for(let i=0;i<N;i++){
    const a = (Math.PI*2) * (i/N) + (Math.random()*0.22-0.11);
    const sp = 2.2 + Math.random()*5.2;
    sparks.push({
      x: cx,
      y: cy,
      vx: Math.cos(a)*sp,
      vy: Math.sin(a)*sp,
      g: 0.06 + Math.random()*0.06,
      r: 1.8 + Math.random()*2.8,
      a: 1,
      c: palette[Math.floor(Math.random()*palette.length)],
      life: 1
    });
  }
  if(!running) runFx();
}

function runFx(){
  running = true;
  fxCtx.clearRect(0,0,innerWidth, innerHeight);
  confetti = confetti.filter(p => p.a > 0.03 && p.y < innerHeight + 70);
  sparks = sparks.filter(s => s.a > 0.04 && s.life > 0);

  // Confetti rectangles
  for(const p of confetti){
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.rot += p.vr;
    p.a *= 0.985;

    fxCtx.save();
    fxCtx.globalAlpha = p.a;
    fxCtx.translate(p.x, p.y);
    fxCtx.rotate(p.rot);
    fxCtx.fillStyle = p.c;
    fxCtx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    fxCtx.restore();
  }

  // Fireworks sparks (glowy circles)
  for(const s of sparks){
    s.vy += s.g;
    s.x += s.vx;
    s.y += s.vy;
    s.vx *= 0.985;
    s.vy *= 0.985;
    s.a *= 0.975;
    s.life *= 0.985;
    fxCtx.save();
    fxCtx.globalAlpha = Math.max(0, s.a);
    fxCtx.shadowColor = s.c;
    fxCtx.shadowBlur = 16;
    fxCtx.fillStyle = s.c;
    fxCtx.beginPath();
    fxCtx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    fxCtx.fill();
    fxCtx.restore();
  }

  if(confetti.length || sparks.length){
    requestAnimationFrame(runFx);
  }else{
    fxCtx.clearRect(0,0,innerWidth, innerHeight);
    running = false;
  }
}

/* ===== UI elements ===== */
const timerWidget = document.getElementById("timerWidget");
const twSeconds = document.getElementById("twSeconds");
const btnFast = document.getElementById("btnFast");
const btnReset = document.getElementById("btnReset");
const countdownEl = document.getElementById("countdown");
const resultEl = document.getElementById("result");

function setBusy(isBusy){
  timerWidget.setAttribute('aria-disabled', isBusy ? 'true' : 'false');
  btnFast.disabled = isBusy;
  btnReset.disabled = isBusy;
  btnClear.disabled = isBusy;
}

/* ===== Popup ===== */
const overlay = document.getElementById("overlay");
const popupIcon = document.getElementById("popupIcon");
const popupName = document.getElementById("popupName");
document.getElementById("btnOk").onclick = () => overlay.classList.remove("show");
document.getElementById("btnAgain").onclick = () => {
  overlay.classList.remove("show");
  if(!spinning && !timer) btnFast.click(); // quay l·∫°i theo "quay ngay"
};
overlay.addEventListener("click", (e)=>{ if(e.target === overlay) { overlay.classList.remove("show"); overlay.classList.remove('firework'); } });
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && overlay.classList.contains("show")) { overlay.classList.remove("show"); overlay.classList.remove('firework'); }
});
function showPopupCustom(title, icon, name, againMode){
  // againMode: 'spin' (quay l·∫°i), 'close' (·∫©n n√∫t quay l·∫°i)
  const tEl = document.getElementById('popupTitle');
  const hEl = document.getElementById('popupHint');
  const againBtn = document.getElementById('btnAgain');
  tEl.textContent = title;
  popupIcon.textContent = icon;
  popupName.textContent = name;
  hEl.textContent = 'Nh·∫•n OK ho·∫∑c b·∫•m ra ngo√†i ƒë·ªÉ ƒë√≥ng';
  if(againMode === 'spin'){
    againBtn.style.display = '';
    againBtn.textContent = 'QUAY L·∫†I';
  }else{
    againBtn.style.display = 'none';
  }
  overlay.classList.add('show');
}
function showResultPopup(item){
  // Fireworks right when popup shows
  overlay.classList.add('firework');
  showPopupCustom('üéâ K·∫æT QU·∫¢ C·ª¶A B·∫†N üéâ', item.icon, item.name, 'spin');
  const cx = innerWidth/2;
  const cy = Math.max(140, innerHeight*0.25);
  fireworksBurst(cx, cy);
  // second burst for more "wow"
  setTimeout(()=>fireworksBurst(cx-120, cy+40), 120);
  setTimeout(()=>fireworksBurst(cx+120, cy+40), 200);
  vibrateWin();
  // remove class after flash
  setTimeout(()=>overlay.classList.remove('firework'), 700);
}
function showTimeUpPopup(){
  showPopupCustom('‚è∞ H·∫æT GI·ªú!', '‚è∞', 'ƒê√£ h·∫øt 10 gi√¢y', 'close');
}
function vibrateWin(){
  try{
    if(navigator.vibrate){ navigator.vibrate([45, 35, 45]); }
  }catch(e){}
}

/* ===== Spin core ===== */
function doSpin(){
  spinning = true;

  const startAngle = angle;
  const target = startAngle + Math.PI*10 + Math.random()*Math.PI*2;
  const start = performance.now();
  const duration = 2700;

  let lastIdx = currentIndexFromAngle(angle);
  playTick();

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

  function anim(now){
    const t = Math.min(1, (now-start)/duration);
    const eased = easeOutCubic(t);
    angle = startAngle + (target-startAngle)*eased;
    drawWheel(angle);

    const idx = currentIndexFromAngle(angle);
    if(idx !== lastIdx){
      lastIdx = idx;
      playTick();
    }

    if(t < 1){
      requestAnimationFrame(anim);
    }else{
      spinning = false;
      const idxFinal = currentIndexFromAngle(angle);
      const item = items[idxFinal];

      resultEl.textContent = item.icon + " " + item.name;
      addHistory(item);
      confettiBurst();
      playWin();
      showResultPopup(item);

      setBusy(false);
      countdownEl.textContent = "‚Äî";
      resetCountdownUI();
    }
  }
  requestAnimationFrame(anim);
}

/* ===== Countdown 10s (via widget) ===== */
let timer = null;
let timerRunning = false;
let remaining = 10;
function resetCountdownUI(){
  remaining = 10;
  twSeconds.textContent = String(remaining);
  countdownEl.textContent = '‚Äî';
}
function startCountdownOnly(){
  if(timer || spinning) return;
  ensureAudio();
  if(musicToggle.checked) startMusic();
  timerRunning = true;
  setBusy(true);
  remaining = 10;
  countdownEl.textContent = remaining + 's';
  twSeconds.textContent = String(remaining);
  resultEl.textContent = '‚è≥';
  playCountdownBeep(remaining);
  timer = setInterval(()=>{
    remaining--;
    countdownEl.textContent = (remaining>0?remaining:'0') + 's';
    twSeconds.textContent = String(Math.max(0, remaining));
    if(remaining>0) playCountdownBeep(remaining);
    if(remaining<=0){
      clearInterval(timer);
      timer = null;
      timerRunning = false;
      setBusy(false);
      resultEl.textContent = '‚è∞';
      playTimeUp();
      showTimeUpPopup();
      resetCountdownUI();
    }
  }, 1000);
}
timerWidget.addEventListener('click', ()=>{
  if(timerWidget.getAttribute('aria-disabled')==='true') return;
  startCountdownOnly();
});
timerWidget.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' || e.key===' '){ e.preventDefault(); startCountdownOnly(); }
});

/* ===== Spin now (no timer) ===== */
btnFast.onclick = ()=>{
  playDrumRoll();

  if(timer || spinning) return;
  ensureAudio(); // unlock audio on gesture
  if(musicToggle.checked) startMusic();
  countdownEl.textContent = "‚Äî";
  resultEl.textContent = "üéØ";
  setBusy(true);
  playStartWhoosh();
  doSpin();
};

btnReset.onclick = ()=>{
  if(spinning || timer) return;
  angle = 0;
  drawWheel(angle);
  countdownEl.textContent = "‚Äî";
  resultEl.textContent = "‚ú®";
  resetCountdownUI();
};

/* init */
resetCountdownUI();
drawWheel(angle);

/* ===== Extra polish JS ===== */
(function makeCoins(){
  const L = document.getElementById('coinLayer');
  if(!L) return;
  for(let i=0;i<10;i++){
    const c=document.createElement('div');
    c.className='coin';
    c.style.left=Math.random()*100+'vw';
    c.style.animationDuration=(5+Math.random()*5)+'s';
    c.style.setProperty('--dx',(Math.random()*120-60)+'px');
    c.style.animationDelay=(-Math.random()*6)+'s';
    L.appendChild(c);
  }
})();
</script>
</body>
</html>
