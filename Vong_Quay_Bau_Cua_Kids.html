<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V√≤ng Quay B·∫ßu Cua T·∫øt (Kids) ‚Äì ¬©devbayosi</title>
  <style>
    :root{
      --font: 'Segoe UI', Roboto, 'Noto Sans', Arial, sans-serif;
      --red:#c1121f;
      --red2:#9d0208;
      --gold:#ffd166;
      --gold2:#ff9f1c;
      --ink:#1f2937;
      --card: rgba(255,255,255,.82);
      --line: rgba(0,0,0,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,210,215,.9) 0%, transparent 55%),
        radial-gradient(1100px 800px at 90% 15%, rgba(255,235,210,.9) 0%, transparent 55%),
        linear-gradient(180deg, #fff1f2, #ffe0d2 65%, #ffd6a5);
      overflow-x:hidden;
    }
    .tet-lantern{
      position: fixed;
      width: 190px; height: 190px;
      border-radius: 999px;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(255,209,102,.18) 30%, rgba(193,18,31,.26) 58%, rgba(193,18,31,.05) 76%, transparent 78%);
      pointer-events:none;
      opacity:.9;
      animation: floaty 7.5s ease-in-out infinite;
      z-index:0;
      filter: blur(.1px);
    }
    .tet-lantern.l1{ left:-46px; top:70px; transform: rotate(10deg); }
    .tet-lantern.l2{ right:-70px; top:130px; width:230px; height:230px; animation-duration:9.2s; opacity:.72; }
    .tet-sparkle{
      position: fixed;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.45) 0 2px, transparent 3px),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.38) 0 1.8px, transparent 3px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,.30) 0 1.6px, transparent 3px),
        radial-gradient(circle at 90% 70%, rgba(255,255,255,.28) 0 1.6px, transparent 3px);
      opacity:.35;
      animation: sparkleMove 6s linear infinite;
      z-index:0;
    }
    .petals{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .petal{
      position:absolute;
      width: 14px; height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,230,180,.25), rgba(255,182,193,.85) 55%, rgba(193,18,31,.35));
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      opacity: .75;
      transform: rotate(12deg);
      animation: fall linear infinite;
    }
    @keyframes floaty{ 0%,100%{ transform: translateY(0) rotate(10deg); } 50%{ transform: translateY(10px) rotate(6deg);} }
    @keyframes sparkleMove{ 0%{ transform: translateY(0);} 100%{ transform: translateY(-14px);} }
    @keyframes fall{ from{ transform: translateY(-15vh) translateX(0) rotate(0deg);} to{ transform: translateY(110vh) translateX(70px) rotate(360deg);} }
    .wrap{
      position: relative;
      z-index:1;
      width: min(1320px, 96vw);
      margin: 18px auto 28px;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding: 10px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--line);
      box-shadow: 0 16px 30px rgba(0,0,0,.10);
      font-weight:900;
    }
    .brand .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.2), rgba(255,209,102,.9) 45%, rgba(193,18,31,.95));
      box-shadow: 0 12px 20px rgba(0,0,0,.12);
      display:grid; place-items:center;
      font-size: 22px;
    }
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding: 12px 14px;
      border-radius: 16px;
      font-weight: 900;
      font-family:var(--font);
      box-shadow: 0 14px 26px rgba(0,0,0,.16);
      transition: transform .06s ease, filter .12s ease;
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px); }
    .btn.spin{ background: linear-gradient(180deg, #ff4d6d, #9d0208); color:white; }
    .btn.round{ background: linear-gradient(180deg, var(--gold), var(--gold2)); color:#2b1d00; }
    .btn.clear{ background: linear-gradient(180deg, #94d2bd, #2a9d8f); color:#063b33; }
    .btn.sound{ background: linear-gradient(180deg, #ff7aa2, var(--red)); color:white; }
    .speedBox{
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--line);
      box-shadow: 0 16px 30px rgba(0,0,0,.10);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 230px;
      align-items:center;
    }
    .speedLabel{ font-weight: 900; font-size: 12px; opacity:.92; }
    .speedRange{ width: 215px; accent-color: var(--red); }
    .speedMarks{
      width: 215px;
      display:flex;
      justify-content:space-between;
      font-weight: 900;
      font-size: 11px;
      opacity: .86;
    }
    .speedMarks span.active{ color: var(--red2); text-shadow: 0 2px 0 rgba(255,255,255,.6); }
    .grid{ display:block; }
    @media (min-width: 980px){
      .grid{
        display:grid;
        grid-template-columns: 1fr 420px;
        gap: 18px;
        align-items:start;
      }
      .right{
        position: sticky;
        top: 14px;
      }
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 22px;
      box-shadow: 0 18px 36px rgba(0,0,0,.12);
      overflow:hidden;
    }
    .historyCard{
      border: 2px solid rgba(255,209,102,.85);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,245,230,.86));
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 16px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .cardTitle{
      font-weight:900;
      font-size: 16px;
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:900;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,245,230,.90));
      border: 1px solid var(--line);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
    }
    .wheelBody{ padding: 14px 16px 18px; }
    .wheelStage{
      position: relative;
      width: min(520px, 92vw);
      margin: 10px auto 8px;
      aspect-ratio: 1 / 1;
    }
    canvas#wheel{
      width: 100%;
      height: 100%;
      display:block;
      border-radius: 50%;
      background: transparent;
      box-shadow: inset 0 0 0 10px rgba(255,255,255,.45), 0 20px 40px rgba(0,0,0,.18);
    }
    .pointer{
      position:absolute;
      left:50%;
      top: 26px;
      transform: translateX(-50%);
      width:0; height:0;
      border-left:20px solid transparent;
      border-right:20px solid transparent;
      border-top:38px solid var(--red);
      z-index: 40;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    .pointer::after{
      content:"";
      position:absolute;
      left:-11px;
      top:-31px;
      width:0;height:0;
      border-left:11px solid transparent;
      border-right:11px solid transparent;
      border-top:19px solid var(--gold);
    }
    .pointer::before{
      content:"";
      position:absolute;
      left:-12px;
      top:-54px;
      width:24px;height:24px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.15), rgba(255,209,102,.95) 55%, rgba(216,166,63,.95));
      box-shadow: 0 14px 22px rgba(0,0,0,.18);
    }
    .pointer.snap{ animation: snap .35s ease-out 1; }
    @keyframes snap{ 0%{ transform: translateX(-50%) scale(1);} 50%{ transform: translateX(-50%) scale(1.12);} 100%{ transform: translateX(-50%) scale(1);} }
    .timerBox{
      width: min(520px, 92vw);
      margin: 10px auto 0;
      padding: 12px 14px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,245,230,.88));
      border: 1px solid var(--line);
      box-shadow: 0 14px 26px rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .timerBig{ display:flex; align-items:baseline; gap:10px; font-weight:900; }
    .timerBig .num{
      font-size: 30px;
      letter-spacing: .5px;
      color: var(--red2);
      text-shadow: 0 2px 0 rgba(255,255,255,.55);
    }
    .timerBig .label{ font-size: 14px; opacity:.9; }
    .timerHint{ font-weight:800; font-size: 12px; opacity:.87; }
    .lockTag{
      display:none;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(193,18,31,.10);
      border: 1px solid rgba(193,18,31,.25);
      font-weight: 900;
      color: var(--red2);
    }
    .lockTag.show{ display:inline-flex; }
    .timerPulse{ animation: pulse 1s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{ transform: scale(1);} 50%{ transform: scale(1.05);} }
    .historyBody{ padding: 10px 12px 14px; }
    .historyScroll{ max-height: 540px; overflow:auto; padding-right: 4px; }
    .historyScroll::-webkit-scrollbar{ width: 10px; }
    .historyScroll::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.18); border-radius: 999px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size: 13px; }
    thead th{
      text-align:center;
      position: sticky; top: 0; z-index: 1;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(4px);
      padding: 10px 8px;
      font-weight: 900;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    tbody td{ padding: 10px 8px; border-bottom: 1px solid rgba(0,0,0,.06); text-align:center; font-weight: 800; }
    tbody tr:nth-child(odd){ background: rgba(255,255,255,.55); }
    tbody tr.historyNew{ animation: popRow .6s ease-out 1; }
    @keyframes popRow{ 0%{ transform: translateX(18px) scale(.98); opacity:.4;} 60%{ transform: translateX(0) scale(1.02); opacity:1;} 100%{ transform: translateX(0) scale(1); opacity:1;} }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 14px;
      background: linear-gradient(180deg, #fff, #fff3de);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      font-weight: 900;
    }
    .badge .ico{ font-size:22px; line-height:1; }
    .historyFlash{ animation: historyGlow .42s ease-out 1; }
    @keyframes historyGlow{ 0%{ box-shadow: 0 0 0 rgba(255,209,102,0);} 50%{ box-shadow: 0 0 26px rgba(255,209,102,.55);} 100%{ box-shadow: 0 0 0 rgba(255,209,102,0);} }
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      display:none; align-items:center; justify-content:center;
      z-index: 999;
    }
    .overlay.show{ display:flex; }
    .popup{
      width: min(540px, 92vw);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,245,230,.88));
      border: 2px solid rgba(255,209,102,.85);
      box-shadow: 0 24px 50px rgba(0,0,0,.22);
      padding: 14px 16px 16px;
      position: relative;
      overflow:hidden;
      animation: popIn .28s ease-out forwards, popBounce .55s ease-out 1;
    }
    @keyframes popIn{ from{ transform: translateY(14px) scale(.96); opacity:.2;} to{ transform: translateY(0) scale(1); opacity:1;} }
    @keyframes popBounce{ 0%{ transform: translateY(8px) scale(.96);} 55%{ transform: translateY(0) scale(1.04);} 100%{ transform: translateY(0) scale(1);} }
    .popupTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; font-weight: 900; }
    .xbtn{
      border:none; cursor:pointer;
      width: 36px; height: 36px;
      border-radius: 999px;
      font-weight: 900;
      background: var(--red);
      color:white;
      box-shadow: 0 14px 22px rgba(0,0,0,.18);
    }
    .resultBig{ font-weight: 900; font-size: 34px; text-align:center; margin: 10px 0 6px; }
    .resultBig.punch{ animation: punch .55s ease-out 1; }
    @keyframes punch{ 0%{ transform: scale(.92); filter: blur(1px); opacity:.6;} 55%{ transform: scale(1.08); filter: blur(0); opacity:1;} 100%{ transform: scale(1);} }
    .sub{ text-align:center; font-weight: 800; opacity: .9; margin-bottom: 10px; }
    .popupBtns{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
    .fireCanvas{ position:absolute; inset:0; pointer-events:none; opacity: .95; }
    .soundOverlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      display:none; align-items:center; justify-content:center;
      z-index: 1000;
    }
    .soundOverlay.show{ display:flex; }
    .soundBox{
      width: min(560px, 92vw);
      border-radius: 24px;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,230,.90));
      border: 2px solid rgba(255,209,102,.85);
      box-shadow: 0 24px 50px rgba(0,0,0,.22);
      padding: 14px 16px 16px;
      position: relative;
    }
    .soundBox .closeSound{
      position:absolute; right:14px; top:12px;
      border:none; cursor:pointer;
      width: 36px; height: 36px;
      border-radius: 999px;
      font-weight:900;
      background: var(--red);
      color:white;
      box-shadow: 0 14px 22px rgba(0,0,0,.18);
    }
    .soundTitle{ font-weight:900; margin-bottom: 10px; display:flex; align-items:center; gap:10px; }
    .togRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin: 10px 0 12px; }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      border: 1px solid var(--line);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      font-weight: 900;
      cursor: pointer;
      user-select:none;
    }
    .toggle input{ transform: scale(1.25); accent-color: var(--red); }
    .mp3Bar{
      margin-top: 8px;
      display:flex; flex-direction:column; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: 18px;
      background: linear-gradient(180deg, #fff7ec, #ffe7c6);
      border: 2px solid #ffd166;
      box-shadow: 0 14px 28px rgba(0,0,0,.15);
    }
    .mp3Bar label{ font-weight:900; text-align:center; }
    .mp3Input{
      width: min(380px, 90vw);
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed rgba(0,0,0,.18);
      background: rgba(255,255,255,.92);
      font-weight: 800;
    }
    .btnStopBGM{
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 900;
      border: none;
      cursor: pointer;
      background: linear-gradient(180deg, #ff4d6d, #9d0208);
      color: white;
      box-shadow: 0 12px 22px rgba(0,0,0,.16);
    }
    .btnStopBGM:active{ transform: translateY(1px); }
    .hintSmall{ font-size: 12px; font-weight: 800; opacity:.92; text-align:center; }
    footer{ text-align:center; opacity:.85; font-weight: 800; margin-top: 14px; padding: 10px 0 18px; }
    body.present{ cursor:none; }
    body.present footer{ display:none; }
  </style>
</head>
<body>
  <div class="tet-lantern l1"></div>
  <div class="tet-lantern l2"></div>
  <div class="tet-sparkle"></div>
  <div class="petals" id="petals"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üßß</div>
        <div>
          <div style="font-size:16px; font-weight:900;">V√íNG QUAY B·∫¶U CUA T·∫æT</div>
          <!-- <div style="font-size:12px; font-weight:800; opacity:.86;">Thi·∫øu nhi ‚Ä¢ Gameshow üé• ‚Ä¢ Font TV chu·∫©n Vi·ªát</div> -->
        </div>
      </div>

      <div class="controls">
        <button class="btn spin" id="btnSpin">üé° QUAY</button>

        <div class="speedBox" title="Ch·ªânh t·ªëc ƒë·ªô quay">
          <div class="speedLabel">üéöÔ∏è T·ªêC ƒê·ªò</div>
          <input id="speedRange" class="speedRange" type="range" min="1" max="3" step="1" value="2" aria-label="T·ªëc ƒë·ªô quay">
          <div class="speedMarks">
            <span id="m1">Ch·∫≠m</span><span id="m2">R·∫•t ch·∫≠m</span><span id="m3">Si√™u ch·∫≠m</span>
          </div>
        </div>

        <button class="btn round" id="btnStartTimer">‚è± B·∫ÆT ƒê·∫¶U 10 GI√ÇY</button>
        <button class="btn round" id="btnNewRound">üÜï L∆Ø·ª¢T M·ªöI</button>
        <button class="btn clear" id="btnClearHistory">üßπ X√ìA L·ªäCH S·ª¨</button>
        <button class="btn sound" id="btnSoundPanel">üéµ √ÇM THANH</button>
        <button class="btn sound" id="btnFullscreen">üñ•Ô∏è FULLSCREEN</button>
      </div>
    </div>

    <div class="grid">
      <div class="card wheelCard">
        <div class="cardHead">
          <div class="cardTitle">üé° V√≤ng quay</div>
          <div class="pill">
            <span>üíø <strong>Nh·∫°c:</strong> <span id="bgmState">T·∫Øt</span></span>
            <span>üîä <strong>Hi·ªáu ·ª©ng:</strong> <span id="sfxState">B·∫≠t</span></span>
          </div>
        </div>

        <div class="wheelBody">
          <div class="wheelStage">
            <div class="pointer" id="pointer" aria-label="M≈©i t√™n ch·ªâ k·∫øt qu·∫£"></div>
            <canvas id="wheel" width="900" height="900"></canvas>
          </div>

          <div class="timerBox">
            <div class="timerBig">
              <span class="num" id="timerNum">10</span>
              <span class="label">GI√ÇY</span>
              <span class="lockTag" id="lockTag">‚õî H·∫æT GI·ªú ‚Äì KH√ìA QUAY</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:2px;align-items:flex-end;">
              <div class="timerHint">B·ªô ƒë·∫øm ƒë·ªôc l·∫≠p. H·∫øt 10s s·∫Ω b√°o v√† <b>kh√¥ng quay</b>.</div>
              <div class="timerHint">B·∫•m <b>ƒê√ìNG</b> ƒë·ªÉ m·ªü kh√≥a.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card historyCard right">
        <div class="cardHead">
          <div class="cardTitle">üìä B·∫£ng k·∫øt qu·∫£</div>
          <div class="pill"><span>üßæ T·ªëi ƒëa <strong>10</strong> l∆∞·ª£t</span></div>
        </div>
        <div class="historyBody">
          <div class="historyScroll">
            <table aria-label="B·∫£ng k·∫øt qu·∫£">
              <thead>
                <tr>
                  <th>#</th>
                  <th>K·∫øt qu·∫£</th>
                  <th>Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <footer>Ch√∫c m·ª´ng nƒÉm m·ªõi! üéäüß®üêâ ‚Ä¢ (¬©devbayosi)</footer>
  </div>

  <div class="overlay" id="overlay">
    <div class="popup" role="dialog" aria-modal="true" aria-label="K·∫øt qu·∫£">
      <canvas class="fireCanvas" id="fireCanvas"></canvas>
      <div class="popupTop">
        <div id="popupTitle">üéâ K·∫æT QU·∫¢</div>
        <button class="xbtn" id="btnClosePopup">‚úñ</button>
      </div>
      <div class="resultBig" id="resultText">‚Äî</div>
      <div class="sub" id="resultSub">Ch√∫c b·∫°n may m·∫Øn!</div>
      <div class="popupBtns">
        <button class="btn round" id="btnPopupNewRound">üÜï ƒê√ìNG</button>
        <button class="btn spin" id="btnPopupSpin">üé° QUAY TI·∫æP</button>
      </div>
    </div>
  </div>

  <div class="soundOverlay" id="soundOverlay">
    <div class="soundBox" role="dialog" aria-modal="true" aria-label="C√†i ƒë·∫∑t √¢m thanh">
      <button class="closeSound" id="closeSound">‚úñ</button>
      <div class="soundTitle">üéµ C√†i ƒë·∫∑t √¢m thanh</div>

      <div class="togRow">
        <label class="toggle" title="B·∫≠t/t·∫Øt hi·ªáu ·ª©ng √¢m thanh">
          <input type="checkbox" id="sfxToggle" checked>
          HI·ªÜU ·ª®NG
        </label>
        <label class="toggle" title="B·∫≠t/t·∫Øt nh·∫°c n·ªÅn m·∫∑c ƒë·ªãnh">
          <input type="checkbox" id="bgmToggle">
          NH·∫†C M·∫∂C ƒê·ªäNH
        </label>
      </div>

      <div class="mp3Bar">
        <label>üìÅ T·∫£i nh·∫°c n·ªÅn MP3 t·ª´ m√°y</label>
        <input id="bgmFile" class="mp3Input" type="file" accept="audio/mpeg,audio/mp3" />
        <button id="btnStopMP3" class="btnStopBGM" type="button">‚èπ D·ª™NG MP3</button>
        <div class="hintSmall">Ch·ªçn file .mp3 ‚Ä¢ Nh·∫°c s·∫Ω l·∫∑p (loop) ‚Ä¢ MP3 kh√¥ng l√†m m·∫•t hi·ªáu ·ª©ng tr√≤ ch∆°i</div>
      </div>

      <div class="mp3Bar" style="margin-top:14px;">
        <label>üéõÔ∏è √Çm l∆∞·ª£ng NH·∫†C N·ªÄN</label>
        <input id="musicVolume" type="range" min="0" max="100" value="35" class="mp3Input">
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button id="btnMusicPause" class="btnStopBGM" type="button">‚è∏Ô∏è T·∫†M D·ª™NG NH·∫†C</button>
          <button id="btnMusicPlay"  class="btnStopBGM" type="button">‚ñ∂Ô∏è PH√ÅT NH·∫†C</button>
          <button id="btnMusicStop"  class="btnStopBGM" type="button">‚èπÔ∏è D·ª™NG NH·∫†C</button>
        </div>
        <div class="hintSmall">Ch·ªâ ƒëi·ªÅu ch·ªânh NH·∫†C (kh√¥ng ·∫£nh h∆∞·ªüng ‚Äút·∫°ch‚Äù, win, countdown‚Ä¶)</div>
      </div>

      <div class="mp3Bar" style="margin-top:12px;">
        <label>üéÆ √Çm l∆∞·ª£ng HI·ªÜU ·ª®NG</label>
        <input id="sfxVolume" type="range" min="0" max="100" value="90" class="mp3Input">
        <div class="hintSmall">ƒêi·ªÅu ch·ªânh ri√™ng hi·ªáu ·ª©ng tr√≤ ch∆°i</div>
      </div>
    </div>
  </div>

  <audio id="bgmAudio" loop preload="auto"></audio>

  <script>
    const items = [
      { key:"bau", name:"B·∫ßu", icon:"üéÉ" },
      { key:"cua", name:"Cua", icon:"ü¶Ä" },
      { key:"tom", name:"T√¥m", icon:"ü¶ê" },
      { key:"ca",  name:"C√°",  icon:"üêü" },
      { key:"ga",  name:"G√†",  icon:"üêî" },
      { key:"nai", name:"Nai", icon:"ü¶å" },
    ];

    const speedRange = document.getElementById('speedRange');
    const speedMarks = [document.getElementById('m1'), document.getElementById('m2'), document.getElementById('m3')];
    function getSpinConfig(){
      const v = Number(speedRange?.value || 2);
      if(v === 1) return { duration: 6500, extraTurns: Math.PI * 18 };
      if(v === 3) return { duration: 11500, extraTurns: Math.PI * 30 };
      return { duration: 9000, extraTurns: Math.PI * 24 };
    }
    function refreshSpeedMarks(){
      const v = Number(speedRange?.value || 2);
      speedMarks.forEach((el,i)=> el && el.classList.toggle('active', (i+1)===v));
    }
    if(speedRange){
      speedRange.addEventListener('input', ()=>{
        refreshSpeedMarks();
        showSmallToast(`üéöÔ∏è T·ªëc ƒë·ªô: ${speedRange.value==1?'Ch·∫≠m':speedRange.value==2?'R·∫•t ch·∫≠m':'Si√™u ch·∫≠m'}`);
      });
      refreshSpeedMarks();
    }

    const btnFullscreen = document.getElementById('btnFullscreen');
    let wakeLock = null;
    async function requestWakeLock(){
      try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){}
    }
    async function lockOrientation(){
      try{ if(screen.orientation && screen.orientation.lock){ await screen.orientation.lock('landscape'); } }catch(e){}
    }
    async function enterPresentMode(){
      try{ await document.documentElement.requestFullscreen(); }catch(e){}
      document.body.classList.add('present');
      await requestWakeLock(); await lockOrientation();
      showSmallToast("üñ•Ô∏è ƒêang tr√¨nh chi·∫øu (ESC ƒë·ªÉ tho√°t)");
    }
    async function exitPresentMode(){
      try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){}
      document.body.classList.remove('present');
      try{ if(wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(e){}
      showSmallToast("‚Ü©Ô∏è Tho√°t fullscreen");
    }
    if(btnFullscreen){
      btnFullscreen.addEventListener('click', async ()=>{
        ensureAudio();
        if(audioCtx.state==="suspended") await audioCtx.resume();
        if(!document.fullscreenElement) enterPresentMode();
        else exitPresentMode();
      });
    }
    document.addEventListener('fullscreenchange', ()=>{
      if(!document.fullscreenElement){
        document.body.classList.remove('present');
        try{ if(wakeLock){ wakeLock.release(); wakeLock=null; } }catch(e){}
      }
    });

    const petals = document.getElementById('petals');
    function spawnPetals(){
      if(!petals) return;
      petals.innerHTML = "";
      const n = 20;
      for(let i=0;i<n;i++){
        const p = document.createElement('div');
        p.className = "petal";
        p.style.left = (Math.random()*100) + "vw";
        p.style.top = (-10 - Math.random()*50) + "vh";
        p.style.animationDuration = (8 + Math.random()*10) + "s";
        p.style.animationDelay = (-Math.random()*10) + "s";
        p.style.opacity = String(0.35 + Math.random()*0.55);
        petals.appendChild(p);
      }
    }
    spawnPetals();

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const radius = Math.min(W,H)*0.46;

    let spinning = false;
    let angle = 0;
    let lastTickIdx = -1;
    let currentPointerIdx = 0;
    const POINTER_ANGLE = -Math.PI/2;

    function normalize(a){ a = a % (Math.PI*2); if(a < 0) a += Math.PI*2; return a; }
    function indexFromPointer(wheelAngle){
      const slice = (Math.PI*2) / items.length;
      const a = normalize(POINTER_ANGLE - wheelAngle);
      const idx = Math.floor(a / slice);
      return (idx + items.length) % items.length;
    }

    function drawMaiFlower(x,y,scale=1){
      ctx.save(); ctx.translate(x,y); ctx.scale(scale, scale);
      const petalR = 52, petalW = 36, petals = 5;
      for(let i=0;i<petals;i++){
        ctx.save(); ctx.rotate((Math.PI*2/petals)*i);
        const g = ctx.createRadialGradient(0,-petalR*0.55, 6, 0,-petalR*0.55, petalR*1.2);
        g.addColorStop(0, "rgba(255,215,120,0.98)");
        g.addColorStop(0.55, "rgba(255,209,102,0.98)");
        g.addColorStop(1, "rgba(255,159,28,0.92)");
        ctx.beginPath();
        ctx.moveTo(0, -petalR);
        ctx.bezierCurveTo(petalW, -petalR*0.55, petalW, -petalR*0.05, 0, petalR*0.25);
        ctx.bezierCurveTo(-petalW, -petalR*0.05, -petalW, -petalR*0.55, 0, -petalR);
        ctx.closePath();
        ctx.fillStyle = g;
        ctx.shadowColor = "rgba(0,0,0,.10)";
        ctx.shadowBlur = 4;
        ctx.fill();
        ctx.lineWidth = 3.5;
        ctx.strokeStyle = "rgba(193,18,31,0.30)";
        ctx.shadowBlur = 0;
        ctx.stroke();
        ctx.restore();
      }
      const cg = ctx.createRadialGradient(-6,-6, 3, 0,0, 24);
      cg.addColorStop(0, "rgba(255,190,90,0.98)");
      cg.addColorStop(1, "rgba(255,120,40,0.92)");
      ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2);
      ctx.fillStyle = cg;
      ctx.shadowColor = "rgba(0,0,0,.08)";
      ctx.shadowBlur = 3;
      ctx.fill();
      ctx.shadowBlur = 0;
      for(let k=0;k<10;k++){
        const a = (Math.PI*2)*(k/10);
        const r1 = 9, r2 = 22;
        ctx.beginPath();
        ctx.moveTo(Math.cos(a)*r1, Math.sin(a)*r1);
        ctx.lineTo(Math.cos(a)*r2, Math.sin(a)*r2);
        ctx.strokeStyle = "rgba(255,215,120,0.75)";
        ctx.lineWidth = 2.0;
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(Math.cos(a)*r2, Math.sin(a)*r2, 2.0, 0, Math.PI*2);
        ctx.fillStyle = "rgba(255,215,120,0.80)";
        ctx.fill();
      }
      ctx.restore();
    }

    function drawWheel(wheelAngle){
      ctx.clearRect(0,0,W,H);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.beginPath(); ctx.arc(0,0,radius*1.02,0,Math.PI*2);
      ctx.fillStyle = "rgba(0,0,0,.05)";
      ctx.fill();
      ctx.restore();

      const slice = (Math.PI*2) / items.length;

      ctx.save(); ctx.translate(cx, cy); ctx.rotate(wheelAngle);
      for(let i=0;i<items.length;i++){
        const a0 = i*slice, a1 = a0 + slice;
        const g = ctx.createRadialGradient(0,0,radius*0.15, 0,0,radius);
        const tint = (i%2===0) ? "rgba(193,18,31,.22)" : "rgba(255,209,102,.18)";
        g.addColorStop(0, "rgba(255,255,255,.00)");
        g.addColorStop(0.50, "rgba(255,255,255,.08)");
        g.addColorStop(1, tint);

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,a0,a1);
        ctx.closePath();
        ctx.fillStyle = g;
        ctx.fill();

        ctx.lineWidth = 6;
        ctx.strokeStyle = "rgba(255,255,255,.72)";
        ctx.stroke();

        const mid = (a0+a1)/2;
        const rIcon = radius*0.62;
        const ix = Math.cos(mid)*rIcon;
        const iy = Math.sin(mid)*rIcon;

        ctx.save();
        ctx.translate(ix, iy);
        ctx.rotate(mid + Math.PI/2);
        ctx.font = "900 92px " + getComputedStyle(document.body).fontFamily;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,.18)";
        ctx.shadowBlur = 10;
        ctx.fillText(items[i].icon, 0, -6);
        ctx.restore();

        const rLab = radius*0.83;
        const lx = Math.cos(mid)*rLab;
        const ly = Math.sin(mid)*rLab;
        ctx.save();
        ctx.translate(lx, ly);
        ctx.rotate(mid + Math.PI/2);
        ctx.font = "900 28px " + getComputedStyle(document.body).fontFamily;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "rgba(20,20,20,.86)";
        ctx.shadowColor = "rgba(255,255,255,.35)";
        ctx.shadowBlur = 4;
        ctx.fillText(items[i].name.toUpperCase(), 0, 0);
        ctx.restore();
      }
      ctx.restore();

      drawMaiFlower(cx, cy, (radius/230));

      const idx = currentPointerIdx ?? 0;
      const a0 = idx*slice;
      const a1 = a0 + slice;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(wheelAngle);
      ctx.lineWidth = Math.max(12, radius*0.08);
      ctx.strokeStyle = "rgba(255,209,102,0.98)";
      ctx.shadowColor = "rgba(255,209,102,0.85)";
      ctx.shadowBlur = 22;
      ctx.beginPath();
      ctx.arc(0,0,radius*0.92,a0,a1);
      ctx.stroke();

      ctx.lineWidth = Math.max(5, radius*0.035);
      ctx.shadowBlur = 8;
      ctx.strokeStyle = "rgba(255,255,255,0.70)";
      ctx.beginPath();
      ctx.arc(0,0,radius*0.86,a0,a1);
      ctx.stroke();
      ctx.restore();
    }

    const sfxToggle = document.getElementById('sfxToggle');
    const bgmToggle = document.getElementById('bgmToggle');
    const sfxState = document.getElementById('sfxState');
    const bgmState = document.getElementById('bgmState');

    let audioCtx = null;
    let master = null;
    let sfxGain = null;
    let musicGain = null;
    let musicTimer = null;
    let bassNode = null;
    let rollNode = null;

    function ensureAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain(); master.gain.value = 0.85; master.connect(audioCtx.destination);
      sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.9; sfxGain.connect(master);
      musicGain = audioCtx.createGain(); musicGain.gain.value = 0.12; musicGain.connect(master);
    }
    function canSfx(){ return !!sfxToggle?.checked; }
    function beep(freq=880, dur=0.06, type="square", vol=0.22){
      if(!canSfx()) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(vol, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      o.connect(g).connect(sfxGain);
      o.start(t); o.stop(t+dur+0.02);
    }
    function playTick(){
      if(!canSfx()) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(1200, t);
      o.frequency.exponentialRampToValueAtTime(650, t+0.02);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.18, t+0.006);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.04);
      o.connect(g).connect(sfxGain);
      o.start(t); o.stop(t+0.05);

      const bufferSize = 256;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * Math.exp(-i/55);
      const n = audioCtx.createBufferSource(); n.buffer = buffer;
      const ng = audioCtx.createGain(); ng.gain.value = 0.07;
      n.connect(ng).connect(sfxGain);
      n.start(t);
    }
    function playWin(){
      if(!canSfx()) return;
      beep(988, 0.08, "triangle", 0.18);
      setTimeout(()=>beep(1318, 0.10, "triangle", 0.22), 90);
      setTimeout(()=>beep(1760, 0.12, "triangle", 0.24), 200);
    }
    function playTimeUp(){
      if(!canSfx()) return;
      beep(330, 0.11, "sawtooth", 0.22);
      setTimeout(()=>beep(220, 0.14, "sawtooth", 0.22), 120);
    }
    function playCountdownTick(secLeft){
      if(!canSfx()) return;
      const base = 520 + (10-secLeft)*55;
      beep(base, 0.06, "square", 0.18);
      if(secLeft <= 3){ setTimeout(()=>beep(base+220, 0.05, "square", 0.16), 90); }
    }
    function playWhoosh(){
      if(!canSfx()) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const dur = 0.35;
      const bufferSize = Math.floor(audioCtx.sampleRate * dur);
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){
        const k = i/bufferSize;
        data[i] = (Math.random()*2-1) * (1-k) * 0.7;
      }
      const n = audioCtx.createBufferSource(); n.buffer = buffer;
      const gg = audioCtx.createGain();
      gg.gain.setValueAtTime(0.0001, t);
      gg.gain.exponentialRampToValueAtTime(0.18, t+0.02);
      gg.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      n.connect(gg).connect(sfxGain);
      n.start(t);
    }
    function startDrumRoll(totalMs){
      if(!canSfx()) return;
      ensureAudio();
      stopDrumRoll();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "triangle";
      o.frequency.setValueAtTime(120, t0);
      o.frequency.exponentialRampToValueAtTime(220, t0 + Math.min(3.0, totalMs/1000));
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(0.08, t0+0.08);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + totalMs/1000);
      o.connect(g).connect(sfxGain);
      o.start(t0);
      o.stop(t0 + totalMs/1000 + 0.05);
      rollNode = o;
    }
    function stopDrumRoll(){ try{ rollNode?.stop(); }catch(e){} rollNode = null; }

    function stopDefaultBgm(){
      if(musicTimer){ clearInterval(musicTimer); musicTimer = null; }
      try{ bassNode?.stop(); }catch(e){}
      bassNode = null;
    }
    function startDefaultBgm(){
      ensureAudio();
      stopDefaultBgm();
      musicGain.gain.value = Math.max(0, Math.min(0.35, (Number(musicVolume?.value||35)/100)*0.35));
      const bass = audioCtx.createOscillator();
      const bassG = audioCtx.createGain();
      bass.type = "sine";
      bass.frequency.value = 110;
      bassG.gain.value = 0.0001;
      bass.connect(bassG).connect(musicGain);
      bass.start();
      bassNode = bass;

      const scale = [392, 440, 523.25, 659.25, 783.99];
      let step = 0;

      function pluck(freq, t, dur=0.18){
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "triangle";
        o.frequency.setValueAtTime(freq, t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.12, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
        o.connect(g).connect(musicGain);
        o.start(t); o.stop(t+dur+0.05);
      }
      function kick(t){
        bassG.gain.cancelScheduledValues(t);
        bass.frequency.setValueAtTime(160, t);
        bass.frequency.exponentialRampToValueAtTime(80, t+0.1);
        bassG.gain.setValueAtTime(0.0001, t);
        bassG.gain.exponentialRampToValueAtTime(0.25, t+0.02);
        bassG.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
      }
      const intervalMs = 140;
      musicTimer = setInterval(()=>{
        if(!bgmToggle.checked) return;
        const t = audioCtx.currentTime + 0.01;
        if(step % 4 === 0) kick(t);
        pluck(scale[step % scale.length], t);
        step++;
      }, intervalMs);
    }

    bgmToggle.addEventListener('change', ()=>{
      ensureAudio();
      if(audioCtx.state === "suspended") audioCtx.resume();
      applyVolumeDefaults();
      if(bgmToggle.checked){
        stopUploadedBGM();
        startDefaultBgm();
        bgmState.textContent = "B·∫≠t";
      }else{
        stopDefaultBgm();
        bgmState.textContent = "T·∫Øt";
      }
    });
    sfxToggle.addEventListener('change', ()=>{ sfxState.textContent = sfxToggle.checked ? "B·∫≠t" : "T·∫Øt"; });

    const bgmAudio = document.getElementById('bgmAudio');
    const bgmFile = document.getElementById('bgmFile');
    const btnStopMP3 = document.getElementById('btnStopMP3');
    let bgmObjectUrl = null;

    function stopUploadedBGM(){ try{ bgmAudio.pause(); }catch(e){} }
    function setUploadedBGM(file){
      if(!file) return;
      if(bgmObjectUrl){ try{ URL.revokeObjectURL(bgmObjectUrl); }catch(e){} bgmObjectUrl=null; }
      bgmObjectUrl = URL.createObjectURL(file);
      bgmAudio.src = bgmObjectUrl;
      bgmAudio.volume = Math.max(0, Math.min(1, Number(musicVolume?.value||35)/100));
      bgmAudio.loop = true;

      bgmToggle.checked = false;
      stopDefaultBgm();
      bgmState.textContent = "MP3";

      bgmAudio.play().catch(()=>{
        showPopup("üéµ CH∆ØA PH√ÅT ƒê∆Ø·ª¢C", "H√£y ch·∫°m/b·∫•m th√™m 1 l·∫ßn r·ªìi ch·ªçn l·∫°i MP3 nh√©!");
      });
    }
    bgmFile.addEventListener('change', ()=>{
      const f = bgmFile.files && bgmFile.files[0];
      if(f) setUploadedBGM(f);
    });
    btnStopMP3.addEventListener('click', ()=>{
      stopUploadedBGM();
      try{ bgmAudio.currentTime = 0; }catch(e){}
      if(!bgmToggle.checked) bgmState.textContent = "T·∫Øt";
      showSmallToast("‚èπÔ∏è ƒê√£ d·ª´ng MP3");
    });

    const soundOverlay = document.getElementById('soundOverlay');
    const btnSoundPanel = document.getElementById('btnSoundPanel');
    const closeSound = document.getElementById('closeSound');
    btnSoundPanel.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      soundOverlay.classList.add('show');
      ensureAudio();
      if(audioCtx.state === "suspended") audioCtx.resume();
      applyVolumeDefaults();
    });
    closeSound.addEventListener('click', ()=> soundOverlay.classList.remove('show'));
    soundOverlay.addEventListener('click', (e)=>{ if(e.target===soundOverlay) soundOverlay.classList.remove('show'); });

    const musicVolume = document.getElementById('musicVolume');
    const sfxVolumeSlider = document.getElementById('sfxVolume');
    const btnMusicPause = document.getElementById('btnMusicPause');
    const btnMusicPlay  = document.getElementById('btnMusicPlay');
    const btnMusicStop  = document.getElementById('btnMusicStop');

    function setMusicVol(v){
      if(musicGain) musicGain.gain.value = Math.max(0, Math.min(0.35, (v/100)*0.35));
      bgmAudio.volume = Math.max(0, Math.min(1, v/100));
    }
    function setSfxVol(v){ if(sfxGain) sfxGain.gain.value = Math.max(0, Math.min(1, v/100)); }
    function applyVolumeDefaults(){
      if(musicVolume) setMusicVol(Number(musicVolume.value||35));
      if(sfxVolumeSlider) setSfxVol(Number(sfxVolumeSlider.value||90));
    }
    if(musicVolume){
      musicVolume.addEventListener('input', ()=>{
        ensureAudio();
        if(audioCtx.state==="suspended") audioCtx.resume();
        setMusicVol(Number(musicVolume.value));
        showSmallToast("üéõÔ∏è Nh·∫°c: " + musicVolume.value + "%");
      });
    }
    if(sfxVolumeSlider){
      sfxVolumeSlider.addEventListener('input', ()=>{
        ensureAudio();
        if(audioCtx.state==="suspended") audioCtx.resume();
        setSfxVol(Number(sfxVolumeSlider.value));
        showSmallToast("üéÆ Hi·ªáu ·ª©ng: " + sfxVolumeSlider.value + "%");
      });
    }
    function pauseMusic(){
      stopDefaultBgm();
      try{ bgmAudio.pause(); }catch(e){}
      bgmState.textContent = "T·∫Øt";
    }
    async function playMusic(){
      ensureAudio();
      if(audioCtx.state==="suspended") await audioCtx.resume();
      applyVolumeDefaults();
      if(bgmAudio.src){
        bgmAudio.play().catch(()=>{});
        bgmState.textContent = "MP3";
        bgmToggle.checked = false;
        stopDefaultBgm();
      }else{
        bgmToggle.checked = true;
        startDefaultBgm();
        bgmState.textContent = "B·∫≠t";
      }
    }
    function stopMusic(){
      pauseMusic();
      try{ bgmAudio.currentTime = 0; }catch(e){}
      showSmallToast("‚èπÔ∏è ƒê√£ d·ª´ng nh·∫°c");
    }
    btnMusicPause?.addEventListener('click', ()=>{ pauseMusic(); showSmallToast("‚è∏Ô∏è T·∫°m d·ª´ng nh·∫°c"); });
    btnMusicPlay?.addEventListener('click', ()=>{ playMusic(); showSmallToast("‚ñ∂Ô∏è Ph√°t nh·∫°c"); });
    btnMusicStop?.addEventListener('click', stopMusic);

    const overlay = document.getElementById('overlay');
    const resultText = document.getElementById('resultText');
    const resultSub = document.getElementById('resultSub');
    const popupTitle = document.getElementById('popupTitle');
    const btnClosePopup = document.getElementById('btnClosePopup');
    const btnPopupNewRound = document.getElementById('btnPopupNewRound');
    const btnPopupSpin = document.getElementById('btnPopupSpin');
    function showPopup(title, sub){
      popupTitle.textContent = title;
      resultText.textContent = "‚Äî";
      resultSub.textContent = sub || " ";
      overlay.classList.add('show');
      stopFireworks();
    }
    function showResult(item){
      popupTitle.textContent = "üéâ K·∫æT QU·∫¢";
      resultText.textContent = `${item.icon} ${item.name}`;
      resultText.classList.remove('punch'); void resultText.offsetWidth; resultText.classList.add('punch');
      resultSub.textContent = "M≈©i t√™n tr·ªè ƒë√∫ng √¥ n√†o th√¨ ra √¥ ƒë√≥! ‚úÖ";
      overlay.classList.add('show');
      startFireworks();
    }
    function closePopup(){ overlay.classList.remove('show'); stopFireworks(); }
    btnClosePopup.addEventListener('click', closePopup);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closePopup(); });
    btnPopupNewRound.addEventListener('click', ()=>{ closePopup(); resetTimer(); });
    btnPopupSpin.addEventListener('click', ()=>{ closePopup(); doSpin(); });

    const fireCanvas = document.getElementById('fireCanvas');
    const fctx = fireCanvas.getContext('2d');
    let fwTimer = null;
    let sparks = [];
    function resizeFire(){
      const r = overlay.getBoundingClientRect();
      fireCanvas.width = Math.floor(r.width * devicePixelRatio);
      fireCanvas.height = Math.floor(r.height * devicePixelRatio);
      fireCanvas.style.width = r.width + "px";
      fireCanvas.style.height = r.height + "px";
      fctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    }
    function burst(){
      const w = overlay.getBoundingClientRect().width;
      const h = overlay.getBoundingClientRect().height;
      const x = w*0.5 + (Math.random()*80-40);
      const y = h*0.28 + (Math.random()*40-20);
      const n = 70;
      for(let i=0;i<n;i++){
        const a = (Math.PI*2) * (i/n);
        const sp = 2.2 + Math.random()*3.2;
        sparks.push({ x,y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp, life: 70 + Math.random()*40, r: 2 + Math.random()*2 });
      }
    }
    function drawFire(){
      const w = overlay.getBoundingClientRect().width;
      const h = overlay.getBoundingClientRect().height;
      fctx.clearRect(0,0,w,h);
      sparks = sparks.filter(s=> s.life>0);
      for(const s of sparks){
        s.x += s.vx; s.y += s.vy;
        s.vy += 0.035;
        s.vx *= 0.985; s.vy *= 0.985;
        s.life -= 1;
        const alpha = Math.max(0, Math.min(1, s.life/90));
        fctx.beginPath();
        fctx.fillStyle = `rgba(${200+Math.random()*55},${120+Math.random()*135},${40+Math.random()*120},${alpha})`;
        fctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        fctx.fill();
      }
    }
    function startFireworks(){
      resizeFire();
      burst(); burst();
      if(fwTimer) clearInterval(fwTimer);
      fwTimer = setInterval(()=>{
        if(Math.random()<0.28) burst();
        drawFire();
      }, 30);
    }
    function stopFireworks(){
      if(fwTimer){ clearInterval(fwTimer); fwTimer=null; }
      const w = overlay.getBoundingClientRect().width;
      const h = overlay.getBoundingClientRect().height;
      fctx.clearRect(0,0,w,h);
      sparks = [];
    }
    window.addEventListener('resize', ()=>{ if(overlay.classList.contains('show')) resizeFire(); });

    let toastEl = null;
    function showSmallToast(text){
      if(!toastEl){
        toastEl = document.createElement('div');
        toastEl.style.position = "fixed";
        toastEl.style.left = "50%";
        toastEl.style.bottom = "18px";
        toastEl.style.transform = "translateX(-50%)";
        toastEl.style.padding = "10px 14px";
        toastEl.style.borderRadius = "999px";
        toastEl.style.fontWeight = "900";
        toastEl.style.background = "rgba(255,255,255,.90)";
        toastEl.style.border = "1px solid rgba(0,0,0,.10)";
        toastEl.style.boxShadow = "0 14px 26px rgba(0,0,0,.18)";
        toastEl.style.zIndex = "1200";
        document.body.appendChild(toastEl);
      }
      toastEl.textContent = text;
      toastEl.style.opacity = "1";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>{ toastEl.style.opacity="0"; }, 1300);
    }

    const timerNum = document.getElementById('timerNum');
    const lockTag = document.getElementById('lockTag');
    const btnStartTimer = document.getElementById('btnStartTimer');
    const btnNewRound = document.getElementById('btnNewRound');
    let timerLeft = 10, timerRunning = false, timerLocked = false, timerInt = null;
    function renderTimer(){ timerNum.textContent = String(timerLeft); lockTag.classList.toggle('show', timerLocked); }
    function resetTimer(){
      timerLeft = 10; timerRunning = false; timerLocked = false;
      timerNum.classList.remove('timerPulse');
      clearInterval(timerInt); timerInt=null;
      renderTimer();
    }
    function startTimer(){
      if(timerRunning) return;
      timerRunning = true; timerLocked = false; timerLeft = 10; renderTimer();
      ensureAudio(); if(audioCtx.state==="suspended") audioCtx.resume(); applyVolumeDefaults();
      timerNum.classList.add('timerPulse');
      playCountdownTick(timerLeft);
      timerInt = setInterval(()=>{
        timerLeft -= 1;
        renderTimer();
        playCountdownTick(timerLeft);
        if(timerLeft <= 0){
          clearInterval(timerInt); timerInt=null;
          timerRunning = false; timerLocked = true;
          timerNum.classList.remove('timerPulse');
          renderTimer();
          playTimeUp();
          showPopup("‚è∞ H·∫æT GI·ªú!", "B·∫°n ƒë√£ h·∫øt 10 gi√¢y. V√≤ng quay s·∫Ω KH√îNG quay. B·∫•m L∆Ø·ª¢T M·ªöI ƒë·ªÉ ti·∫øp t·ª•c.");
        }
      }, 1000);
    }
    btnStartTimer.addEventListener('click', ()=> startTimer());
    btnNewRound.addEventListener('click', ()=>{ resetTimer(); showSmallToast("üÜï ƒê√£ m·ªü kh√≥a l∆∞·ª£t m·ªõi!"); });

    const historyBody = document.getElementById('historyBody');
    const btnClearHistory = document.getElementById('btnClearHistory');
    let history = [];
    function nowTime(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function renderHistory(){
      historyBody.innerHTML = "";
      history.forEach((h,i)=>{
        const rank = history.length - i;
        const tr = document.createElement('tr');
        if(i===0) tr.classList.add('historyNew');
        tr.innerHTML = `<td style="font-weight:900">${rank}</td>
                        <td><span class="badge"><span class="ico">${h.icon}</span><span>${h.name}</span></span></td>
                        <td style="font-weight:900">${h.time}</td>`;
        historyBody.appendChild(tr);
      });
    }
    function flashHistory(){
      const card = document.querySelector('.historyCard');
      if(!card) return;
      card.classList.remove('historyFlash'); void card.offsetWidth;
      card.classList.add('historyFlash');
      setTimeout(()=>card.classList.remove('historyFlash'), 420);
    }
    function addHistory(item){
      history.unshift({ name:item.name, icon:item.icon, time: nowTime() });
      if(history.length > 10) history = history.slice(0,10);
      renderHistory(); flashHistory();
    }
    btnClearHistory.addEventListener('click', ()=>{ history = []; renderHistory(); showSmallToast("üßπ ƒê√£ x√≥a l·ªãch s·ª≠!"); });

    const btnSpin = document.getElementById('btnSpin');
    const pointerEl = document.getElementById('pointer');
    function easeOutQuint(t){ return 1 - Math.pow(1 - t, 5); }

    function doSpin(){
      if(spinning) return;
      if(timerLocked){ showPopup("‚õî KH√îNG TH·ªÇ QUAY", "B·∫°n ƒë√£ h·∫øt gi·ªù. B·∫•m L∆Ø·ª¢T M·ªöI ƒë·ªÉ m·ªü kh√≥a quay."); return; }
      ensureAudio();
      if(audioCtx.state==="suspended") audioCtx.resume();
      applyVolumeDefaults();
      spinning = true;
      lastTickIdx = -1;
      const cfg = getSpinConfig();
      const duration = cfg.duration;
      const extraTurns = cfg.extraTurns;
      playWhoosh();
      startDrumRoll(duration*0.82);

      const startAngle = angle;
      const target = startAngle + extraTurns + Math.random()*Math.PI*2;
      const t0 = performance.now();

      function step(now){
        const p = Math.min(1, (now - t0) / duration);
        const e = easeOutQuint(p);
        angle = startAngle + (target - startAngle) * e;

        const idxNow = indexFromPointer(angle);
        currentPointerIdx = idxNow;

        if(idxNow !== lastTickIdx){
          lastTickIdx = idxNow;
          playTick();
        }

        drawWheel(angle);

        if(p < 1) requestAnimationFrame(step);
        else{
          spinning = false;
          stopDrumRoll();
          const idxFinal = indexFromPointer(angle);
          currentPointerIdx = idxFinal;
          drawWheel(angle);
          pointerEl.classList.add('snap');
          setTimeout(()=>pointerEl.classList.remove('snap'), 380);
          const item = items[idxFinal];
          playWin();
          if(navigator.vibrate) try{ navigator.vibrate([40,40,40]); }catch(e){}
          addHistory(item);
          setTimeout(()=> showResult(item), 120);
        }
      }
      requestAnimationFrame(step);
    }
    btnSpin.addEventListener('click', doSpin);

    currentPointerIdx = indexFromPointer(angle);
    drawWheel(angle);
    renderTimer();
    renderHistory();

    window.addEventListener('keydown', (e)=>{
      if(e.key === "Escape"){
        closePopup();
        soundOverlay.classList.remove('show');
        if(document.fullscreenElement) exitPresentMode();
      }
    });
  </script>
</body>
</html>
